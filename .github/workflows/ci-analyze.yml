name: CI-Analyze

on:
  push:
    paths-ignore: [man/**, conf/**, README.md, LICENSE, .gitignore, rust-rudo.spec]
  pull_request:
    paths-ignore: [man/**, conf/**, README.md, LICENSE, .gitignore, rust-rudo.spec]

env:
  CARGO_TERM_COLOR: always

jobs:
  code-analyze:

    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v2
    - name: Install dependency
      run: sudo apt install libpam0g-dev libsystemd-dev
    - uses: actions-rs/clippy-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        args: --all-features --all-targets --verbose
    - uses: actions-rs/cargo@v1
      with:
        command: clean
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: true
    - uses: actions-rs/cargo@v1
      with:
        command: test
        args: --all-features --all-targets --no-fail-fast
        env:
          CARGO_INCREMENTAL: '0'
          RUSTFLAGS: '-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests'
          RUSTDOCFLAGS: '-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests'
    - id: coverage grcov
      uses: actions-rs/grcov@v0.1
      - uses: actions-rs/grcov@v0.1
